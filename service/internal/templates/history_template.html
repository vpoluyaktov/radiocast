<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report History - Radiocast</title>
    <link rel="stylesheet" href="/static/styles.css" type="text/css">
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WPRFL98D');</script>
    <!-- End Google Tag Manager -->
</head>

<body
    style="background-image: url('/static/background.png'); background-size: cover; background-repeat: no-repeat; background-position: center center; background-attachment: fixed;">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WPRFL98D" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Navigation Header -->
    <div class="nav-header">
        <button class="nav-button hamburger-menu" id="hamburgerMenu" title="Main Menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <button class="nav-button refresh-button" id="refreshButton" title="Go to Latest Report">
            <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
                <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                <path d="M21 21v-5h-5" />
            </svg>
        </button>
        <div class="nav-dropdown" id="navDropdown">
            <a href="/" class="nav-dropdown-item">üì° Latest Report</a>
            <a href="/history" class="nav-dropdown-item active">üìÖ History</a>
            <a href="/theory" class="nav-dropdown-item">üìö Theory</a>
        </div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1>üìÖ Report History</h1>
        </div>
        <div class="content">
            <!-- Desktop Split Layout -->
            <div class="desktop-layout">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <button id="prevMonth" class="calendar-nav-btn">‚Äπ</button>
                        <h2 id="currentMonth">Loading...</h2>
                        <button id="nextMonth" class="calendar-nav-btn">‚Ä∫</button>
                    </div>

                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color today"></div>
                            <span>Today</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color has-reports"></div>
                            <span>Reports Available</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color no-reports"></div>
                            <span>No Reports</span>
                        </div>
                    </div>

                    <div class="calendar-container">
                        <div class="calendar-weekdays">
                            <div class="weekday">Sun</div>
                            <div class="weekday">Mon</div>
                            <div class="weekday">Tue</div>
                            <div class="weekday">Wed</div>
                            <div class="weekday">Thu</div>
                            <div class="weekday">Fri</div>
                            <div class="weekday">Sat</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>

                    <div id="loadingIndicator" class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Loading reports...</p>
                    </div>
                </div>

                <div class="preview-section">
                    <div class="preview-header">
                        <h3 id="previewTitle">Select a Report</h3>
                    </div>
                    <div class="preview-container">
                        <iframe id="reportPreview" class="report-iframe" src="about:blank"></iframe>
                        <div id="previewPlaceholder" class="preview-placeholder">
                            <div class="placeholder-content">
                                <h4>üìä Report Preview</h4>
                                <p>Click on a report link in the calendar to preview it here</p>
                            </div>
                        </div>
                    </div>
                    <div class="preview-actions">
                        <button id="viewReportBtn" class="view-report-btn" style="display: none;">View Full
                            Report</button>
                    </div>
                </div>
            </div>

            <!-- Mobile Layout -->
            <div class="mobile-layout">
                <div class="calendar-header">
                    <button id="prevMonthMobile" class="calendar-nav-btn">‚Äπ</button>
                    <h2 id="currentMonthMobile">Loading...</h2>
                    <button id="nextMonthMobile" class="calendar-nav-btn">‚Ä∫</button>
                </div>

                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color today"></div>
                        <span>Today</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color has-reports"></div>
                        <span>Reports Available</span>
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="calendar-weekdays">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    <div id="calendarGridMobile" class="calendar-grid">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="footer-content">
                <div class="service-info">
                    <p>Version: v1.0.0</p>
                    <p class="disclaimer">‚ö†Ô∏è For amateur radio use only. Conditions may vary by location.</p>
                    <p>Developed by KK7UNL</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functionality
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const navDropdown = document.getElementById('navDropdown');
        const refreshButton = document.getElementById('refreshButton');

        // Toggle dropdown menu
        hamburgerMenu.addEventListener('click', function () {
            navDropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            if (!hamburgerMenu.contains(event.target) && !navDropdown.contains(event.target)) {
                navDropdown.classList.remove('show');
            }
        });

        // Refresh button functionality
        refreshButton.addEventListener('click', function () {
            window.location.href = '/';
        });

        // Calendar functionality
        class ReportCalendar {
            constructor() {
                this.currentDate = new Date();
                this.reports = [];
                this.reportsByDate = new Map();
                this.selectedDate = null;

                this.initializeElements();
                this.bindEvents();
                this.loadReports();
            }

            initializeElements() {
                // Desktop elements
                this.prevMonthBtn = document.getElementById('prevMonth');
                this.nextMonthBtn = document.getElementById('nextMonth');
                this.currentMonthEl = document.getElementById('currentMonth');
                this.calendarGrid = document.getElementById('calendarGrid');
                this.loadingIndicator = document.getElementById('loadingIndicator');

                // Mobile elements
                this.prevMonthBtnMobile = document.getElementById('prevMonthMobile');
                this.nextMonthBtnMobile = document.getElementById('nextMonthMobile');
                this.currentMonthElMobile = document.getElementById('currentMonthMobile');
                this.calendarGridMobile = document.getElementById('calendarGridMobile');

                // Preview elements
                this.previewTitle = document.getElementById('previewTitle');
                this.reportPreview = document.getElementById('reportPreview');
                this.previewPlaceholder = document.getElementById('previewPlaceholder');
                this.viewReportBtn = document.getElementById('viewReportBtn');

                this.currentReportUrl = null;
            }

            bindEvents() {
                // Desktop navigation
                this.prevMonthBtn.addEventListener('click', () => this.previousMonth());
                this.nextMonthBtn.addEventListener('click', () => this.nextMonth());

                // Mobile navigation
                this.prevMonthBtnMobile.addEventListener('click', () => this.previousMonth());
                this.nextMonthBtnMobile.addEventListener('click', () => this.nextMonth());

                // Preview functionality
                this.viewReportBtn.addEventListener('click', () => {
                    if (this.currentReportUrl) {
                        window.open(this.currentReportUrl, '_blank');
                    }
                });
            }

            async loadReports() {
                this.showLoading(true);
                try {
                    const response = await fetch('/reports?limit=1000');
                    const data = await response.json();
                    this.reports = data.reports || [];
                    this.processReports();
                    this.renderCalendar();
                } catch (error) {
                    console.error('Failed to load reports:', error);
                    this.showError('Failed to load reports. Please try again.');
                } finally {
                    this.showLoading(false);
                }
            }

            processReports() {
                this.reportsByDate.clear();

                this.reports.forEach(reportPath => {
                    // Extract date from path: reports/2025/09/17/PropagationReport-2025-09-17-09-29-26/index.html
                    const pathParts = reportPath.split('/');
                    if (pathParts.length >= 4) {
                        const year = pathParts[1];
                        const month = pathParts[2];
                        const day = pathParts[3];
                        const dateKey = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                        // Extract timestamp from folder name
                        const folderName = pathParts[4];
                        const timestampMatch = folderName.match(/(\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})/);
                        const timestamp = timestampMatch ? timestampMatch[1] : 'Unknown';

                        if (!this.reportsByDate.has(dateKey)) {
                            this.reportsByDate.set(dateKey, []);
                        }

                        this.reportsByDate.get(dateKey).push({
                            path: reportPath,
                            timestamp: timestamp,
                            displayTime: this.formatTime(timestamp)
                        });
                    }
                });

                // Sort reports by timestamp for each date (chronological order - oldest first)
                this.reportsByDate.forEach(reports => {
                    reports.sort((a, b) => a.timestamp.localeCompare(b.timestamp));
                });
            }

            formatTime(timestamp) {
                if (timestamp === 'Unknown') return 'Unknown';
                // Convert 2025-09-17-09-29-26 to 09:29:26
                const parts = timestamp.split('-');
                if (parts.length >= 6) {
                    return `${parts[3]}:${parts[4]}:${parts[5]}`;
                }
                return timestamp;
            }

            renderCalendar() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();

                const monthText = new Intl.DateTimeFormat('en-US', {
                    month: 'long',
                    year: 'numeric'
                }).format(this.currentDate);

                // Update month headers (both desktop and mobile)
                this.currentMonthEl.textContent = monthText;
                this.currentMonthElMobile.textContent = monthText;

                // Clear calendar grids
                this.calendarGrid.innerHTML = '';
                this.calendarGridMobile.innerHTML = '';

                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                // Determine the starting date for the grid
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                // Calculate how many weeks/days are needed
                const daysFromPrevMonth = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const daysInMonth = lastDay.getDate();
                const totalDaysNeeded = daysFromPrevMonth + daysInMonth;
                const weeksNeeded = Math.ceil(totalDaysNeeded / 7);
                const daysToGenerate = weeksNeeded * 7;

                console.log(`Debug: ${year}-${month + 1} - daysFromPrev: ${daysFromPrevMonth}, daysInMonth: ${daysInMonth}, totalNeeded: ${totalDaysNeeded}, weeks: ${weeksNeeded}, generating: ${daysToGenerate}`);

                // Generate calendar days for both layouts  
                for (let i = 0; i < daysToGenerate; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);

                    const dayElDesktop = this.createDayElement(date, month, 'desktop');
                    const dayElMobile = this.createDayElement(date, month, 'mobile');

                    this.calendarGrid.appendChild(dayElDesktop);
                    this.calendarGridMobile.appendChild(dayElMobile);
                }
            }

            createDayElement(date, currentMonth, layout) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';

                const dayNumber = date.getDate();
                const isCurrentMonth = date.getMonth() === currentMonth;
                const dateKey = date.toISOString().split('T')[0];
                const hasReports = this.reportsByDate.has(dateKey);
                const isToday = this.isToday(date);

                if (!isCurrentMonth) {
                    dayEl.classList.add('other-month');
                }

                if (isToday) {
                    dayEl.classList.add('today');
                }

                if (hasReports) {
                    dayEl.classList.add('has-reports');
                    const reports = this.reportsByDate.get(dateKey);

                    // Create day header with number
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.innerHTML = `<span class="day-number">${dayNumber}</span>`;
                    dayEl.appendChild(dayHeader);

                    // Create reports list
                    const reportsList = document.createElement('div');
                    reportsList.className = 'day-reports';

                    reports.forEach(report => {
                        const reportLink = document.createElement('a');
                        reportLink.className = 'report-link-inline';
                        reportLink.textContent = report.displayTime;
                        reportLink.title = `Report generated at ${report.displayTime}`;

                        if (layout === 'desktop') {
                            // Desktop: show preview on click
                            reportLink.href = '#';
                            reportLink.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                this.showPreview(report);
                            });
                        } else {
                            // Mobile: open directly in new tab
                            reportLink.href = `/${report.path}`;
                            reportLink.target = '_blank';
                            reportLink.addEventListener('click', (e) => {
                                e.stopPropagation();
                            });
                        }

                        reportsList.appendChild(reportLink);
                    });

                    dayEl.appendChild(reportsList);
                } else {
                    dayEl.innerHTML = `
                        <div class="day-header">
                            <span class="day-number">${dayNumber}</span>
                        </div>
                        <div class="no-reports-text">No reports</div>
                    `;
                }

                return dayEl;
            }

            showPreview(report) {
                const reportUrl = `/${report.path}`;
                this.currentReportUrl = reportUrl;

                // Update preview title
                this.previewTitle.textContent = `Report - ${report.displayTime}`;

                // Show iframe and hide placeholder
                this.reportPreview.src = reportUrl;
                this.reportPreview.style.display = 'block';
                this.previewPlaceholder.style.display = 'none';
                this.viewReportBtn.style.display = 'block';
            }

            isToday(date) {
                const today = new Date();
                return date.toDateString() === today.toDateString();
            }


            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.renderCalendar();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.renderCalendar();
            }

            showLoading(show) {
                this.loadingIndicator.style.display = show ? 'block' : 'none';
            }

            showError(message) {
                this.calendarGrid.innerHTML = `<div class="error-message">${message}</div>`;
            }
        }

        // Initialize calendar when page loads
        document.addEventListener('DOMContentLoaded', function () {
            new ReportCalendar();
        });
    </script>
</body>

</html>